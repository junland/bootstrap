#!/bin/bash -e

msg() {
  echo " >>> $1"
}

export -f msg

run_stage() {
    stage_target=$1
    
    if ! test -f $CWD/$stage_target; then
      msg "Stage script does not exist: $stage_target"
      exit 1
    fi

    if test -f $CWD/progress/$stage_target.done; then
      msg "Stage $stage_target has already been completed, skipping..."
      return
    fi

    chmod +x $CWD/$stage_target

    source $CWD/bootstrap.env

    msg "Running stage: $stage_target"

    set -e

    source $CWD/bootstrap.env 2>&1 | tee $CWD/progress/$stage_target.log

    msg "Done with stage: $stage_target"

    touch $CWD/progress/$stage_target.done
}

CWD=$(pwd)
umask 022

if [ "$1" == "" ]; then
  msg "Please specify a architecture to build."
  exit 1
fi

if ! test -f targets/$1.tgt; then
  msg "$1 target does not exist."
  exit 1
fi

if ! test -f $CWD/bootstrap.env; then
  msg "Bootstrap enviroment file does not exist"
  exit 1
fi

set --

msg "Setting up enviroment..."

chmod +x $CWD/bootstrap.env

source $CWD/bootstrap.env

msg "Running stages..."